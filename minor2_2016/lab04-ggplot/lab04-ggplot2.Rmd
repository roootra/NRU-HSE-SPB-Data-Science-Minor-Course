---
title: "Exploratory Data Analysis. Lab 4"
output: html_document
---

- Что такое **разведочный анализ данных** (Exploratory Data Analysis)? Как вы думаете?

### Чеклист разведочного анализа данных

1. Сформулируйте вопрос
2. Загрузите / подготовьте данные
3. Проверьте, все ли в порядке с данными
    4. Выполните `str()`
    5. Посмотрите на первые и последние строки датасета
    6. Проверьте числа (“n”s)
    7. Сопоставьте как минимум с еще одним источником данных
8. Сначала проверьте простое решение
9. Усовершенствуйте свое решение
10. Сделайте выводы

#### 1. Формулировка вопроса

- Есть ли какие-то правила и требования к вопросу?
- Является ли хорошим вопрос "Какая модель автомобиля лучше"? Что нужно, чтобы на него ответить?

#### 2. Загрузка данных

Именно к этому пункту относится загрузка данных (в зависимости от формата файла), чистка данных: различные действия с преобразованиями классов, форматирование, исправление ошибок и опечаток и т.д. 

Мы же сегодня продолжаем работать с данными о характеристиках 38 популярных моделей автомобилей с 1999 по 2008 г.


```{r}
library(ggplot2)
```

Загружаем данные. О чем они?

```{r}
data(mpg)

?ggplot2::mpg
```

#### 3-7. Проверка данных

Посмотрим на данные. Сколько переменных и наблюдений мы имеем? Совпадают ли данные с описанием? 

```{r}
dim(mpg)
head(mpg, n = 3)
```

```{r}
str(mpg)
```

Проверим, данные о машинах какого класса у нас есть. Сколько таких классов?

```{r}
table(mpg$class)
table(mpg$year)
```

Как представлены производители в датасете?

```{r}
table(mpg$manufacturer)
```

Таким образом, мы выполнили п.4-6 чеклиста.

п.7 (Сравнение с еще одним источником данных) более актуален для реальных, а не учебных датасетов
 - похожи ли цифры на правильные (один и тот же порядок, одни и те же единицы измерения)
 
#### 8. Простое решение

Не нужно сразу строить сложные модели и проводить особые тесты -- начните с простого. Одним из удобных методов разведочного анализа являются графики. Они позволяют

- понять основные особенности данных
- увидеть простые закономерности
- заложить основу для построения более сложных моделей
- выполнить эту часть анализа достаточно быстро

А сейчас отвлечемся от пунктов чеклиста и перейдем к инструменту, который позволит строить графики.

## Пакет ggplot2

> "In brief, the grammar tells us that a statistical graphic is a mapping from data to aesthetic attributes (colour, shape, size) of geometric objects (points, lines, bars). The plot may also contain statistical transformations of the data and is drawn on a specific coordinate system"

  - Wickham, H. (2009). *ggplot2: elegant graphics for data analysis*. Springer Science & Business Media.
  
Пакет `ggplot2`, написанный Hadley Wickham, является реализацией "Грамматики графики" (Leland Wilkinson)

- Сайт: [ggplot2.org](http://ggplot2.org)
- Документация: [docs.ggplot2.org](http://docs.ggplot2.org/)
- [Шпаргалка](https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf)

Многое в функциях задано по умолчанию, но есть возможность изменения, так что можно сделать любые персональные модификации

**Загрузка пакета** (повторение)
```{r eval = F}
library(ggplot2)
```

**Основные компоненты**:

- **data frame** = источник данных
- **aesthetic mappings** = как данным сопоставляется цвет / размер / положение (x vs y)  и т.д.
- **geoms** = геометрические объекты (точки, линии, формы) 
- **facets** = графики с условиями (разделениями по классам, например) 
- **stats** = статистические преобразования (сглаживание, разделение на промежутки и т.д.) 
- **scales** = описание шкал (например, male = red, female = blue)
- **coordinate system** = система координат, в которой строится график

Любой график строится слоями:

- `g <- ggplot(data, aes(variable1, variable2))` = создание объекта, соответствующего графику, и указание используемого датасета
    + `aes(x = variable1, y = variable2)` = описание эстетик (в данном случае -- какую переменную мы берем за x, а какую -- за y)
    + `geom_point()` = построение точечного графика на основе указанной ранее информации


**Эстетики**

- `+ geom_point(color, size, alpha)` = определение стиля, согласно которому будет нарисованы точки 
    + *Внимание*: текущее описание справедливо и для других типов графиков (geom_...)
    + `color = "blue"` = задание цвета точек
    + `aes(color = var1)` = задание цвета через категориальную (factor) переменную -- каждой категории будет соответствовать свой цвет, отличающийся от остальных 
    + `size = 4` = задание размера точек
    + `alpha = 0.5` = задание прозрачности точек
    
- [Пример](http://docs.ggplot2.org/current/aes_colour_fill_alpha.html)
- Что вообще можно менять на графиках?
    * Цвет/заливку (color, fill)
    * Размер (size)
    * Прозрачность (alpha)
    * Форму (shape)
    * P.S.: На самом деле менять можно почти все, но об этом чуть позднее.

## Разведочные графики

#### Simple Summaries: одна переменная
* Сводная информация (Summary)
* Столбчатая диаграмма (Barplot)
* Гистограмма (Histogram)
* "Ящик с усами"" (Boxplot)

```{r}
summary(mpg)
```

Столбчатая диаграмма:
```{r}
ggplot() +
  geom_bar(data = mpg, aes(x = class))
```

Сколько миль (по городу) проедут автомобили на одном галлоне топлива? (Гистограмма)

```{r, warning=F, message=F}
ggplot() +
  geom_histogram(data = mpg, aes(x = cty))
```

А если нам нужно понять, насколько значения отклоняются от обобщенного показателя? Посчитаем среднее и медиану:

* что такое медиана
* в чем ее отличие от среднего

```{r}
?mean
?median

mean(mpg$cty)
median(mpg$cty)
```

Графики в ggplot2 строятся слоями: можно сохранить результат в переменную, а потом "дорисовывать" следующие части.
```{r, warning=F, message=F}
g <- ggplot() +
  geom_histogram(data = mpg, aes(x = cty))

g + geom_vline(xintercept = mean(mpg$cty)) + geom_vline(xintercept = median(mpg$cty), color="red")
```

Сколько миль (по городу) проедут автомобили на одном галлоне топлива? (Боксплот)
```{r}
ggplot() +
  geom_boxplot(data = mpg, aes(x = factor(0), y = cty))
```

* В чем отличительные черты гистограммы и боксплота, если они визуализируют одни и те же данные? В каких случаях следует использовать боксплот, а в каких гистограмму?

* Данные каких типов можно использовать для каких графиков?
     * Столбчатая диаграмма (Barplot)
     * Гистограмма (Histogram)
     * "Ящик с усами" (Boxplot)


## Simple Summaries: две переменных
* Диаграмма рассеяния (Scatterplot)
* Комбинации графиков с одной переменной (Multiple or overlayed 1-D plot)
* Использование цвета, размера, формы для увеличения размерности

Какой класс автомобилей наиболее экономичный?

```{r}
ggplot() +
  geom_boxplot(data = mpg, aes(x = class, y = cty))
```

У машин с каким типом привода расход топлива больше?

```{r}
ggplot() +
  geom_histogram(data = mpg, aes(x = cty)) +
  facet_grid(drv~.)
```

Как связана экономичность автомобиля и объем двигателя?

```{r}
ggplot() +
  geom_point(data = mpg, aes(x = displ, y = cty))

ggplot() +
  geom_jitter(data = mpg, aes(x = displ, y = cty))


```

Что делать, если хочется, чтобы этот график выглядел fancy? Раскрасить его!

```{r}
ggplot() +
  geom_point(data = mpg, aes(x = displ, y = cty), color = "blue")
```

Если еще и друзьям (научному руководителю) показать захотелось, тогда надо добавить понятные подписи к осям!

```{r}
ggplot() +
  geom_point(data = mpg, aes(x = displ, y = cty), color = "blue") +
  xlab("Объем двигателя") +
  ylab("Миль на галлон топлива (город)")
```

А если хочется посмотреть, как это двумерное распределение накладывается на разделение автомобилей на классы?

```{r}
ggplot() +
  geom_point(data = mpg, aes(x = displ, y = cty, color = class))
```

* Данные каких типов можно использовать для каких графиков?

#### 9. Совершенствование решения

Простых графиков не всегда достаточно. Иногда, чтобы ответить на вопрос, нужно исследовать более сложные зависимости (но об этом поговорим следующий раз)

#### 10. Выводы

* Подходящие ли у нас данные?
* Не нужно ли нам собрать что-то дополнительно, чтобы более полно ответить на вопрос?
* Корректен ли наш вопрос?

### Принципы аналитической графики
* Показывайте сравнения
* Показывайте структуру, механизмы, причины и следствия
* Показывайте многомерность данных
* Используйте разные подтверждения вашего результата (текст, цифры и т.д.)
* Описывайте и фиксируйте подтверждения/доказательства (так, чтобы зрителю было понятно)
* Главное -- содержание, а не форма

**Вопрос для обсуждения:**
Мы рассматривали разведочный анализ данных и, в частности, разведочные графики (Exploratory Graphs). Чем, по вашему мнению, разведочные графики отличаются от финальных, публикуемых в отчетах, презенациях и т.д.?

**Ваша очередь:**
Проведите разведочный анализ датасета `msleep` из пакета `ggplot2`

```{r eval = F}
?msleep
```


