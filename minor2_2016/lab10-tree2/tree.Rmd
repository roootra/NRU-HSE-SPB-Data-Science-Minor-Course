---
title: "Lab 10. Деревья решений. Часть 2"
output: html_document
---
Вернемся еще раз к интерпретации деревьев

## Классификационные деревья

Загрузим нужный пакет

```{r}
library(partykit)
```

Посмотрим на данные про сорта ирисов

```{r}
data(iris)
head(iris)
?iris
```

Предскажем сорт по остальным характеристикам

```{r}
iris.tree <- ctree(Species ~ ., data = iris)
plot(iris.tree)
plot(iris.tree, type = "simple")
```

Качество предсказания -- confusion table

```{r}
predictedSpecies <- predict(iris.tree, iris)
table(predictedSpecies, iris$Species)
```

* какая доля ирисов virginica предсказана правильно?
* какая доля из ирисов, отнесенных к vercicolor, действительно относится к этому сорту?
* сколько случаев предсказаны правильно?
* какова точность предсказания?

## Регрессионные деревья

Загрузим данные

```{r}
load("/principal/courses/minor2_2016/lab10-tree2/autographs.rda")
```

В феврале 2016 года мы собрали данные с рынка виртуальных товаров steam community market в разделе Dota 2. Мы выделили предметы, которые являются виртуальными автографами. Виртуальные автографы это цифровые подписи известных игроков, которые один раз были созданы игроком, а затем уже продаются копии, то есть автографы одного игрока не уникальны.
Ежегодно организуются турниры серии The International (TI), которые являются аналогом чемпионата мира. Также есть серия турниров Major, турниры которой вторые по престижу после TI и организуются в разных городах. На тот момент последним турниром серии Major был Shanghai Major. 
Мы собрали данные об успехах игроков на этих турнирах. Кроме этого мы включили игровую статистику: количество проф. игр, винрейт, KDA ratio.Также мы взяли информацию, связанную с публичностью игроков: количество подписчиков в twitter, а также количество интервью на медиа разных категорий. Про самих игроков также есть информация о роли в команде (от 5 до 1, роль в команде определяется персонажами, на которых игрок играет, но для нас важно, что чем ниже число - тем выше влияние игрока на исход матча), национальности и количестве призовых мест у команды, членом которой игрок является.
С рынка мы собрали информацию о количестве копий автографа и его цене.


Описание переменных

* Quantity - количество копий автографа на рынке.
* Price - цена за автограф
* Role - роль в команде.
* Country - страна происхождения / национальность
* Last_participation_year - последний год участия на турнире The International
* Best_result_ti - лучший результат на турнире The International за все годы
* Place_num_recent - Место на The International 2015. 0000 - означает место на квалификациях, 00 - означает место на wild card.
* Is_2015 - принимал ли участие на The International 2015 или нет.
* Freq - сколько раз принимал участие на турнире The International.
* Sm_participant - является ли участником Shanghai Major.
* Games_overall - всего профессиональных игр
* Winrate_overall - процент побед за все игры.
* Kda_overall - KDA-статистика за все игры. Kda рассчитывается по формуле: Kills+Assists / Deaths, что означает в скольких убийствах поучаствовал игрок в пересчете на каждую свою смерть.
* Follows - количество подписчиков в твитере
* Interview_quantity - количество интервью в целом.
    * Community - интервью, взятые представителями фан сообщества (с форумов или реддита).
    * Dota - интервью, взятые для сайтов о доте.
    * Site_games - интервью для сайтов об играх в целом.
    * Not_games - интервью для сайтов, не связанных с играми (зачастую национальные СМИ).
    * Teams - интервью для сайтов профессиональных команд.
    * Tournament - интервью, взятые по ходу турнира, специальной командой, его освещающей.
* Sum_top3_places_of_team - Сумма мест от третьего и выше, занятых командой.

Построим модель для предсказания цены автографа

```{r setup,fig.width=11}
tr1.1<-ctree(log(price)~.,data=autographs_model)
plot(tr1.1, gp = gpar(fontsize = 8),     # font size changed to 6
      inner_panel=node_inner,
      ip_args=list(
        abbreviate = F, 
        id = FALSE,
        pval=F)
 )
plot(tr1.1, gp = gpar(fontsize = 8),     # font size changed to 6
      inner_panel=node_inner,
      ip_args=list(
        abbreviate = F, 
        id = FALSE,
        pval=F),
     type = "simple"
 )
```

* зачем мы считаем логарифм от цены?
* какие переменные влияют на цену?

```{r}
predictedPrice <- predict(tr1.1)
plot(predictedPrice, log(autographs_model$price))
```

Как посчитать качество в этом случае? 

```{r}
rss = sum((log(autographs_model$price)-predictedPrice)^2)
tss = sum((log(autographs_model$price) - mean(log(autographs_model$price)))^2)
1 - rss/tss
```

**Ваша очередь:**

* загрузите данные о пассажирах Титаника
```{r}
titanic <- read.csv("/principal/courses/minor2_2016/lab10-tree2/Titanic.csv")
```
* постройте модель для предсказания выживших по полу, возрасту и классу билета 
