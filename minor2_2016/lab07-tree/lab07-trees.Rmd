---
title: "Supervised segmentation and Decision Trees"
---

**Задача:** разработать такие правила, которые позволят разделить данные на группы в соответствии с каком-то интересующим нас показателем.

Примеры:

* есть растения нескольких сортов, нужно выделить признаки, характеризующие каждый сорт
* есть ряд диагнозов, необходимо определить симптомы, соответствующие диагнозу
* есть база клиентов с указанием, кто продолжает пользоваться сервисоами компании, а кто ушел. Нужно выделить признаки, которые позволят выявить "проблемных" клиентов
* ...


* Зачем это нужно? Приведите ваши примеры подобных задач.
* Нужно ли использовать все имеющиеся у нас переменные?
* Как определить, какие из них важны?

Подобные задачи делятся на две групы: задачи регрессии и задачи классификации. Задача классификации возникает  в том случае, если интересующим нас показателем является принадлежность в некоторому классу (болен/не болен, спам/не спам, ушел/остался, высокий/средний/низкий...) -- т.е. категориальная переменная. 

Про задачу регрессии мы говорим тогда, когда мы хотим предсказать некий количественный, числовой показатель (уровень продаж, рейтинг, риск заразиться...).

Рассмотрим, как подобные задачи можно решать с помощью R. Будем использовать пакет `partykit`.

```{r}
library(partykit)
```

### Построение классификационных деревьев

Работаем сегодня с данными Carseats из пакета ISLR о продаже детских автомобильных кресел.

```{r}
library(ISLR)
?ISLR::Carseats
```

* К какому типу переменных относится Sales?

Т.к. классификационные деревья предсказывают принадлежность к той или иной категории, то изменим немного наши данные

```{r}
carseats <- ISLR::Carseats
High=ifelse(carseats$Sales>8,"Yes","No")
library(dplyr)
Carseats <- data.frame(carseats, High)
Carseats <- dplyr::select(Carseats, -Sales)
```

Построим дерево
```{r fig.width=12}
tree.carseats <- ctree(High~., data = Carseats)
tree.carseats
plot(tree.carseats, type = "simple")
plot(tree.carseats)
```

* Можете ли вы "прочитать" это дерево?
* Какие "правила" получились?
* Все ли переменные из данных использованы?

Но насколько хорошо такие правила описывают закономерности?

Разделим данные на две части: на одной будем строить модель, на другой -- проверять. 

* Почему бы не использовать полный датасет на всех этапах?

```{r}
set.seed(2)
train=sample(1:nrow(Carseats), 200)
Carseats.test <- Carseats[-train,]
Carseats.train <- Carseats[train,]
tree.carseats=ctree(High~.,Carseats.train)
```

Теперь предскажем значения (высокие продажи / низкие продажи) согласно этой модели и посмотрим, совпали ли наши предсказания с фактическими значениями

```{r}
tree.pred <- predict(tree.carseats, Carseats.test)
tree.pred

table(tree.pred, Carseats.test$High) ##confusion table
(97+54)/200
```


### Построение регрессионных деревьев

Помяняем немного задачу: не будем делить на высокие и низкие продажи, а просто попробуем предсказать уровень продаж Sales

```{r fig.width=20}
carseats <- ISLR::Carseats
tree.regr <- ctree(Sales~., data = carseats)
plot(tree.regr, type = "simple")
tree.regr
plot(tree.regr)
```

* Какие "правила" для предсказания продаж мы получили в этом случае? 

Как оценить качество регрессионной модели? Разделим выборку снова на две части

```{r}
set.seed(2)
train=sample(1:nrow(carseats), 200)
carseats.test <- carseats[-train,]
carseats.train <- carseats[train,]
tree.regr <- ctree(Sales~., carseats.train)
```

* что будет. если мы попробуем построить матрицу неcоответствий (confusion matrix)? 

```{r}
tree.pred <- predict(tree.regr, carseats.test)
tree.pred

plot(tree.pred, carseats.test$Sales) 
```

Посчитаем, насколько наше предсказание отличается от реального значения

```{r}
sum((tree.pred - carseats.test$Sales)^2) ##RSS
sum((mean(carseats.test$Sales) - carseats.test$Sales)^2) #TSS
sum((tree.pred - carseats.test$Sales)^2)/sum((mean(carseats.test$Sales) - carseats.test$Sales)^2)
```

**Ваша очередь:**

Загрузите данные о стоимости квартир в пригородах Бостона (Boston). Более подробная информация в справке `?Boston`

```{r}
library(MASS)
data(Boston)
```

Разделите цену на высокую и низкую (граница 20)

```{r}
High=ifelse(Boston$medv<=20,"No","Yes")
Boston <- data.frame(Boston, High)
Boston <- dplyr::select(Boston, -medv)
```

Постройте модели для предсказания цены на квартиры
* высокая/низкая
* конкретное значение